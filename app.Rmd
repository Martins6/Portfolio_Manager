---
title: "Shiny Portfolio by Adriel Martins"
runtime: shiny
output:
    flexdashboard::flex_dashboard:
        orientation: rows
        source_code: embed
---

```{r global_setup, include = FALSE}
# This is the setup chunk
library(shiny)
library(flexdashboard)
library(tidyverse)
library(tidyquant)
library(PerformanceAnalytics)
library(timetk)
library(scales)
library(highcharter)
library(broom)
```

Sidebar {.sidebar}
=====================================

```{r}
shiny::helpText('Choose Portfolio')
# Three 'Choose your Stocks and Stock-Weight' Sections
# There are 1-12 columns grid width, we will be choosing as we wish with the 'column' func.
fluidRow(
  column(6,
  textInput("stock1", "Stock 1", "SPY")),
  column(5,
  numericInput("w1", "Portf. %", 47.5, min = 1, max = 100))
)  

fluidRow(
  column(6,
  textInput("stock2", "Stock 2", "VGT")),
  column(5,
  numericInput("w2", "Portf. %", 2.5, min = 1, max = 100))
)

fluidRow(
  column(6,
  textInput("stock3", "Stock 3", 'BRAX11.SA')),
  column(5,
  numericInput("w3", "Portf. %", 26, min = 1, max = 100))
)

fluidRow(
  column(6,
  textInput("stock4", "Stock 4", 'SMAL11.SA')),
  column(5,
  numericInput("w4", "Portf. %", 24, min = 1, max = 100))
)

# One 'Choose your star date' Section
fluidRow(
  column(7,
  dateInput("date", "Starting Date", "2017-01-01", format = "yyyy-mm-dd"))
)

# What is the Window
fluidRow(
  column(5,
  numericInput("window", "Window", 4, min = 3, max = 24, step = 2))
)

shiny::helpText('Sharpe Ratio Section')

# What is the Market Index
fluidRow(
  column(10,
  textInput("idxmarket", "Market Index", 'SPY'))
)

# RFR
fluidRow(
  column(10,
  numericInput("rfr", "RFR%", .03, min = 0, max = 1, step = .0002))
)



# Submit button
actionButton("go", "Submit")
```

```{r global_func, include=FALSE}

prices <- eventReactive(input$go, {
  # Which stocks do we wanna analyze?
  symbols <- c(input$stock1, input$stock2, input$stock3, input$stock4)
  
  # Constructing our Adjusted.Close dataframe with each Stock.
  prices <- 
    # Get the data from Yahoo Finance, we will be working the names of the objects
    getSymbols(symbols, src = 'yahoo', from = input$date, 
               auto.assign = TRUE, warnings = FALSE) %>% 
    # Acessing the xts objects throught the vector of names (get) and getting
    # the the Adjusted.Close (Ad) of each object
    map(~Ad(get(.))) %>% 
    # Instead of multiple data-frames, let us have only one. Merge every dataframe.
    reduce(merge) %>%
    # Change the columname to the Stock's name
    `colnames<-`(symbols)
})

portfolio_returns <- eventReactive(input$go, {
  
  prices <- prices()
  
  # Weights. How much do we invest on each?
  w <- c(input$w1/100, input$w2/100, input$w3/100, input$w4/100)

  # What are our returns?
  asset_returns <-
    prices %>% 
    # Getting the last day of the month only
      to.monthly(indexAt = "last", OHLC = FALSE) %>%
    # xts -> tibble (using tidyquant pkg)
      tk_tbl(preserve_index = TRUE, rename_index = "date") %>%
    # Making our tibble longer, in the sense that we are reorganizing our tibble in fuction
    # Of the dates, and taking every other column, the stocks in our case, 
    # And putting as rows in the column "Assets", and also picking 
    # every cell value and putting into the "Returns" column, accordingly.
      pivot_longer(cols = -date, names_to = 'asset', values_to = 'returns') %>%
    # Filling with true returns our 'Return' column
      group_by(asset) %>%  
      mutate(returns = (log(returns) - log(lag(returns)))) %>%
    # Just to clear the first date, which is lost because we can't have the return of it.
      drop_na()
  
  # Creating our Portfolio Returns with our weights!
  portfolio_returns_dt <- 
    asset_returns %>% 
    tq_portfolio(assets_col = asset, 
               returns_col = returns, 
               weights = w,
               col_rename = "returns") %>% 
    drop_na()
    
})

port_rolling_sd <- eventReactive(input$go, {
  
  # Our window of time (monthly)
  window <- input$window
  
  # As we move to the other month, take the widow of the months prior,
  # and calculate the standard deviation of it. We call this process "rolling".
  portfolio_returns() %>% 
    tq_mutate(mutate_fun = rollapply, # Apply the rolling to our Portfolio
            width = window, # With the window that we want.
            FUN = sd, # Calculating the sd of it
            col_rename = ("rolling_sd")) %>%
  select(date, rolling_sd) %>% 
  na.omit()
  
})


port_rolling_skew <- eventReactive(input$go, {
  
  # Our window of time (monthly)
  window <- input$window
  
  # As we move to the other month, take the widow of the months prior,
  # and calculate the standard deviation of it. We call this process "rolling".
  portfolio_returns() %>% 
    tq_mutate(mutate_fun = rollapply, # Apply the rolling to our Portfolio
            width = window, # With the window that we want.
            FUN = skewness, # Calculating the sd of it
            col_rename = ("rolling_sd")) %>%
  select(date, rolling_sd) %>% 
  na.omit()

})

port_rolling_kurt <- eventReactive(input$go, {
  
  # Our window of time (monthly)
  window <- input$window
  
  # As we move to the other month, take the widow of the months prior,
  # and calculate the standard deviation of it. We call this process "rolling".
  portfolio_returns() %>% 
    tq_mutate(mutate_fun = rollapply, # Apply the rolling to our Portfolio
            width = window, # With the window that we want.
            FUN = kurtosis, # Calculating the sd of it
            col_rename = ("rolling_sd")) %>%
  select(date, rolling_sd) %>% 
  na.omit()

})

```

About
=====================================

This is an Shiny app made by Adriel Martins with the objective to democratize and incetive the more in-depth study of portfolios in the stock market.


Return Distribution
=====================================

Row {data-height=500, .tabset}
-----------------------------------------------------------------------

### Historical Data

```{r}
renderPlot({
  portfolio_returns() %>% 
    ggplot(aes(x = date, y = returns)) + 
    geom_path() +
    ggtitle(label = 'Monthly Log-Return of the Portfolio')
  
})
```

### Rolling Standard-Deviation

```{r}
renderPlot({
  port_rolling_sd() %>%
    ggplot(aes(x = date)) +
    geom_line(aes(y = rolling_sd), color = "cornflowerblue") +
    scale_y_continuous(labels = scales::percent) +
    ggtitle("Portfolio Rolling Volatility", "Using Standard-Deviation") +
    ylab("volatility") +
    scale_x_date(breaks = pretty_breaks(n = 8)) +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))
})
```

### Rolling Skewness

```{r}
renderPlot({
  port_rolling_skew() %>%
    ggplot(aes(x = date)) +
    geom_line(aes(y = rolling_sd), color = "cornflowerblue") +
    ggtitle("Portfolio Rolling Skewness") +
    scale_x_date(breaks = pretty_breaks(n = 8)) +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))
})
```

### Rolling Kurtosis

```{r}
renderPlot({
  port_rolling_kurt() %>%
    ggplot(aes(x = date)) +
    geom_line(aes(y = rolling_sd), color = "cornflowerblue") +
    ggtitle("Portfolio Rolling Kurtosis") +
    scale_x_date(breaks = pretty_breaks(n = 8)) +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))
})
```


Row {.tabset .tabset-fade}
-------------------------------------

### Histogram


```{r}
renderPlot({

  portfolio_returns() %>%
  mutate(hist_col_red = 
           ifelse(returns < (mean(returns) - 2*sd(returns)), 
                  returns, NA),
         hist_col_green = 
           ifelse(returns > (mean(returns) + 2*sd(returns)), 
                  returns, NA),
         hist_col_blue = 
           ifelse(returns > (mean(returns) - 2*sd(returns)) &
                  returns < (mean(returns) + 2*sd(returns)),
                  returns, NA)) %>% 
  ggplot() + 
  geom_histogram(aes(x = hist_col_red),
               alpha = .7, 
               binwidth = .003, 
               fill = "red", 
               color = "red") +
  
  geom_histogram(aes(x = hist_col_green),
               alpha = .7, 
               binwidth = .003, 
               fill = "green", 
               color = "green") +
  
  geom_histogram(aes(x = hist_col_blue),
               alpha = .7, 
               binwidth = .003, 
               fill = "cornflowerblue", 
               color = "cornflowerblue") +
  
scale_x_continuous(breaks = pretty_breaks(n = 10)) +
xlab("monthly returns") +
    ggtitle('Colored by mean +- 2*sd')
})
```

### Density

```{r}
renderPlot({

  portfolio_returns_tq_rebalanced_monthly <- portfolio_returns()
  mean <- mean(portfolio_returns_tq_rebalanced_monthly$returns)
  median <- median(portfolio_returns_tq_rebalanced_monthly$returns)
  
  skew_density_plot <- portfolio_returns_tq_rebalanced_monthly %>% 
    ggplot(aes(x = returns)) +
    stat_density(geom = "line", size = 1, color = "cornflowerblue")
  
  shaded_area_data <- 
    ggplot_build(skew_density_plot)$data[[1]] %>% 
    filter(x < mean)

  skew_density_plot_shaded <- 
    skew_density_plot + 
    geom_area(data = shaded_area_data, aes(x = x, y = y), fill="pink", alpha = 0.5)
  
  median_line_data <- 
    ggplot_build(skew_density_plot)$data[[1]] %>% 
    filter(x <= median)

skew_density_plot_shaded +
  
  geom_segment(data = median_line_data, aes(x = median, y = 0, xend = median, yend = density), 
               color = "black", linetype = "dotted") +
  
  annotate(geom = "text", x = median, y = 5, label = "median", 
           fontface = "plain", angle = 90, alpha = .8, vjust =  1.75) +
  
  annotate(geom = "text", x = (mean - .03), y = .1, label = "returns < mean", 
           fontface = "plain", color = "red", alpha = .8, vjust =  -1) +
  
  ggtitle("Density Plot Illustrating Skewness")
  

  
})

```

Sharpe Ratio
=====================================  

```{r}
# market calculations

rfr <- eventReactive(input$go, {input$rfr/100})

window <- eventReactive(input$go, {input$window}) 


market_returns <- eventReactive(input$go, {
  
    getSymbols("SPY", src = 'yahoo', 
            from = input$date, 
             auto.assign = TRUE, 
             warnings = FALSE) %>% 
    map(~Ad(get(.))) %>% 
    reduce(merge) %>%
    `colnames<-`("SPY") %>% 
    to.monthly(indexAt = "lastof", 
               OHLC = FALSE) %>% 
    Return.calculate(method = "log") %>% 
    na.omit()  
})

market_sharpe <- eventReactive(input$go, {
  
  SharpeRatio(market_returns(),
              Rf = rfr(), 
              FUN = "StdDev")
})

market_rolling_sharpe <- eventReactive(input$go, {
  
  rollapply(market_returns(), 
            window(), 
            function(x) 
            SharpeRatio(x, 
                        Rf = rfr(), 
                        FUN = "StdDev")) %>% 
  na.omit()
})
```

```{r}
# Portfolio calculations

portfolio_returns_xts <- eventReactive(input$go, {
  
  symbols <- c(input$stock1, input$stock2, input$stock3, input$stock4)
  
  validate(need(input$w1 + input$w2 + input$w3 + input$w4 == 100, 
                "The portfolio weights must sum to 100%!"))
  
  w <- c(input$w1/100, input$w2/100, input$w3/100, input$w4/100)
  
  getSymbols(symbols, src = 'yahoo', from = input$date, 
             auto.assign = TRUE, warnings = FALSE) %>% 
  map(~Ad(get(.))) %>% 
  reduce(merge) %>%
  `colnames<-`(symbols) %>% 
  to.monthly(indexAt = "lastof", 
             OHLC = FALSE) %>% 
  Return.calculate(method = "log") %>% 
  na.omit() %>% 
  Return.portfolio(weights = w)
  
})


portfolio_rolling_sharpe <- eventReactive(input$go, {

  rollapply(portfolio_returns_xts(),
            window(),
            function(x) SharpeRatio(x, 
                                    Rf = rfr(), 
                                    FUN = "StdDev")) %>% 
  na.omit()
})

portfolio_sharpe <- eventReactive(input$go, {
  
  validate(need(input$w1 + input$w2 + input$w3 + input$w4 == 100, "------"))
  
  SharpeRatio(portfolio_returns_xts(),
              Rf = rfr(), 
              FUN = "StdDev")
  
})
```

Row {data-height=800}
-----------------------------------------------------------------------

### Rolling Sharpe

```{r}
renderHighchart({
  
  validate(need(input$go, "Please choose your portfolio assets, weights, rfr, rolling window and start date and click submit."))
  
  
  highchart(type = "stock") %>%
  hc_title(text = "Rolling Sharpe") %>%
  hc_add_series(portfolio_rolling_sharpe(), name = "Portfolio", color = "cornflowerblue") %>%
  hc_add_series(market_rolling_sharpe(), name = "Market", color = "green") %>%
  hc_navigator(enabled = FALSE) %>% 
  hc_scrollbar(enabled = FALSE) %>% 
  hc_exporting(enabled = TRUE) %>% 
  hc_legend(enabled = TRUE, align = "right", verticalAlign = "middle",
            layout = "vertical")

  
})
```


Row {data-height=200}
-----------------------------------------------------------------------

### The Sharpe Ratio of Your Portfolio

```{r}
renderValueBox({
  
  
  valueBox(value = tags$p(round(portfolio_sharpe(), 4), 
                          style = "font-size: 70%;"), 
           color = "primary")
})

```

### Sharpe Ratio of the Market in same time period

```{r}
renderValueBox({
  
  valueBox(value = tags$p(round(market_sharpe(), 4), 
                          style = "font-size: 70%;"), 
           color = "primary")
})

```


CAPM Beta
====================================

```{r}
prices <- eventReactive(input$go, {
  
  symbols <- c(input$stock1, input$stock2, input$stock3, input$stock4, input$stock5)
  
  getSymbols(symbols, src = 'yahoo', from = input$date, 
             auto.assign = TRUE, warnings = FALSE) %>% 
  map(~Ad(get(.))) %>% 
  reduce(merge) %>%
  `colnames<-`(symbols)
})


market_return <- eventReactive(input$go, {
  market_return <- 
    getSymbols("SPY", src = 'yahoo', from = input$date, 
             auto.assign = TRUE, warnings = FALSE) %>% 
    map(~Ad(get(.))) %>% 
    reduce(merge) %>%
    `colnames<-`("SPY") %>% 
    to.monthly(indexAt = "lastof", OHLC = FALSE) %>% 
    tk_tbl(preserve_index = TRUE, rename_index = "date") %>%
    mutate(returns = (log(SPY) - log(lag(SPY)))) %>% 
    na.omit() %>%
    select(date, returns)
})


portfolio_returns_tq_rebalanced_monthly <- eventReactive(input$go, {
  
  prices <- prices()
  w <- c(input$w1/100, input$w2/100, input$w3/100, input$w4/100, input$w5/100)
  
  portfolio_returns_tq_rebalanced_monthly <- 
      prices %>% 
      to.monthly(indexAt = "lastof", OHLC = FALSE) %>% 
      tk_tbl(preserve_index = TRUE, rename_index = "date") %>%
      gather(asset, returns, -date) %>% 
      group_by(asset) %>%  
      mutate(returns = (log(returns) - log(lag(returns)))) %>% 
      na.omit() %>%
      tq_portfolio(assets_col  = asset, 
               returns_col = returns,
               weights     = w,
               col_rename  = "returns",
               rebalance_on = "months")
})

beta_dplyr_byhand <- eventReactive(input$go, {
  
  #portfolio_returns_tq_rebalanced_monthly <- portfolio_returns_tq_rebalanced_monthly()
  
  market_return <- market_return()
  
beta_dplyr_byhand <- 
  portfolio_returns_tq_rebalanced_monthly() %>% 
  do(model = lm(returns ~ market_return$returns, data = .))
  
})
  
portfolio_model_augmented <- eventReactive(input$go, {
  
  portfolio_returns_tq_rebalanced_monthly <- portfolio_returns_tq_rebalanced_monthly()
  
  beta_dplyr_byhand() %>% 
  augment(model) %>% 
  rename(mkt_rtns = market_return.returns) %>% 
  select(returns, mkt_rtns, .fitted) %>% 
  mutate(date = portfolio_returns_tq_rebalanced_monthly$date)
  
})

```

Row {data-height=650}
-----------------------------------------------------------------------

### CAPM Highcharter

```{r}
renderHighchart({

portfolio_model_augmented <- portfolio_model_augmented()

highchart() %>% 
  hc_title(text = "Scatter with Regression Line") %>% 
  hc_add_series(portfolio_model_augmented, 
                type = "scatter",
                color = "cornflowerblue",
                hcaes(x = round(mkt_rtns, 4), 
                      y = round(returns, 4),
                      date = date), 
                name = "Returns") %>%
  hc_add_series(portfolio_model_augmented, 
                type = "line", 
                enableMouseTracking = FALSE,
                hcaes(x = mkt_rtns, y = .fitted), 
                name = "CAPM Beta = Slope of Line") %>% 
  hc_xAxis(title = list(text = "Market Returns")) %>% 
  hc_yAxis(title = list(text = "Portfolio Returns")) %>% 
  hc_tooltip(formatter = JS("function(){
     return ('port return: ' + this.y + '  mkt return: ' + this.x +  
     '  date: ' + this.point.date)}"))%>% 
  hc_add_theme(hc_theme_flat()) %>%
  hc_exporting(enabled = TRUE)


})
```


Row 2 {data-height=350}
----------------------------------

### Model Results

```{r}
renderTable({
  beta_dplyr_byhand() %>% 
  tidy(model) %>% 
  mutate(term = c("alpha", "beta"))
}, digits = 4)
```
